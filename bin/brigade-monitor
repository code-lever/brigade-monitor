#!/usr/bin/env ruby

require 'awesome_print'
require 'brigade/monitor'
require 'cgminer/api'
require 'logger'
require 'optparse'
require 'yaml'

me = File.basename(__FILE__)

log = Logger.new(STDOUT)
log.level = Logger::WARN

options = {}
optparse = OptionParser.new do |opts|
  opts.banner = "Usage: #{me} [options]"
  opts.on('-c', '--config FILE', String, 'Configuration file') do |c|
    options[:config] = c
  end
  opts.on('-k', '--key API-KEY', String, 'Brigade API key') do |key|
    options[:key] = key
  end
  opts.on('-d', '--debug LEVEL', [:debug, :info], 'Debug level (debug, info)') do |dbg|
    log.level = { debug: Logger::DEBUG, info: Logger::INFO }.fetch(dbg, Logger::WARN)
  end
  opts.on('-v', '--version', 'Print application version') do
    puts "#{me} v#{Brigade::Monitor::VERSION}"
    exit
  end
end.parse!

fail 'Configuration file is required' unless options[:config]

begin
  config = YAML.load(open(options[:config]).read)
rescue => e
  puts 'An error occurred parsing configuration file'
  fail
end

key = options.fetch(:key, config['api-key'])
fail 'Brigade API key is required' if key.nil?

# build a hash-o-miner clients
miners = config['miners'].map do |miner|
  client = CGMiner::API::Client.new(miner[1]['host'], miner[1]['port'])
  { name: miner[0], client: client }
end

monitor = Brigade::Monitor::Monitor.new(key, miners, log)
monitor.run
